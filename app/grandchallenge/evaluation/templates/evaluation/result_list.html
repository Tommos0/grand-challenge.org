{% extends "site.html" %}
{% load evaluation_extras %}
{% load user_profile_link from profiles %}
{% load humanize %}

{% block pagecontent %}

    <h2>Results</h2>

    <div class="table-responsive">
        <table class="table table-sm" id="resultsTable">
            <thead>
            <tr>
                <th>#</th>
                <th>
                    User
                    {% if site.evaluation_config.use_teams %}
                        (Team)
                    {% endif %}
                </th>
                <th>Created</th>
                <th>{{ site.evaluation_config.score_title }}</th>

                {% for col in site.evaluation_config.extra_results_columns %}
                    <th>{{ col }}</th>
                {% endfor %}

                {% if site.evaluation_config.display_submission_comments %}
                    <th>Comment</th>
                {% endif %}

                {% if site.evaluation_config.show_publication_url %}
                    <th>Publication</th>
                {% endif %}

                {% if site.evaluation_config.show_supplementary_file_link %}
                    <th>{{ site.evaluation_config.supplementary_file_label }}</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for result in object_list %}
                <tr>

                    <td data-order="{{ result.rank }}">{{ result.rank|ordinal }}</td>

                    <td>

                        {{ result.job.submission.creator|user_profile_link }}

                        {% if site.evaluation_config.use_teams %}
                            {% with result|get_team_html as team_html %}
                                {% if team_html %}
                                    ({{ team_html }})
                                {% endif %}
                            {% endwith %}
                        {% endif %}

                    </td>

                    <td data-order="{{ result.created|date:"U" }}"
                        style="white-space: nowrap;">
                        {{ result.created|date:"j N Y" }}
                    </td>

                    <td>
                        <a href="{{ result.absolute_url }}">{{ result.metrics|get_jsonpath:site.evaluation_config.score_jsonpath|floatformat:site.evaluation_config.score_decimal_places }}</a>
                    </td>

                    {% for _, jsonpath in site.evaluation_config.extra_results_columns.items %}
                        <td>{{ result.metrics|get_jsonpath:jsonpath|floatformat:site.evaluation_config.score_decimal_places }}</td>
                    {% endfor %}

                    {% if site.evaluation_config.display_submission_comments %}
                        <td>{{ result.job.submission.comment }}</td>
                    {% endif %}

                    {% if site.evaluation_config.show_publication_url %}
                        <td>
                            {% if result.job.submission.publication_url %}
                                <a href="{{ result.job.submission.publication_url }}">
                                    <i class="fa fa-file"></i>
                                </a>
                            {% endif %}
                        </td>
                    {% endif %}

                    {% if site.evaluation_config.show_supplementary_file_link %}
                        <th>
                            {% if result.job.submission.supplementary_file %}
                                <a href="{{ result.job.submission.supplementary_file.url }}">
                                    <i class="fa fa-file"></i>
                                </a>
                            {% endif %}
                        </th>
                    {% endif %}

                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if site.evaluation_config.result_display_choice == site.evaluation_config.BEST %}
        <p class="small ml-3">Only the best published result for each participant is
            listed.</p>
    {% elif site.evaluation_config.result_display_choice == site.evaluation_config.MOST_RECENT %}
        <p class="small ml-3"> Only the most recent published result for each participant is
            listed.</p>
    {% endif %}

    <script type="text/javascript">
        $(document).ready(function () {
            $('#resultsTable').DataTable({
                {% comment %}
                    The column index of the default sort, must match the table
                    set up.
                {% endcomment %}
                order: [[0, "asc"]],
                "pageLength": 10,
                "columnDefs": [{
                    {%  if site.evaluation_config.show_supplementary_file_link %}
                        "targets": [-1],
                    {% endif %}
                    "searchable": false,
                    "orderable": false
                }],
                ordering: true
            });

        });
    </script>

{% endblock %}
